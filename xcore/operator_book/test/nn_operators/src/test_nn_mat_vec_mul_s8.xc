
#include <stdlib.h>
#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <assert.h>

#include "tst_common.h"

#include "nn_operator.h"
#include "xs3_vpu.h"

// #include "dsp_xs3_vector.h"
#include "Unity.h"

#ifdef __XC__
#define WORD_ALIGNED [[aligned(4)]]
#else
#define WORD_ALIGNED
#endif

#if (defined(__XS3A__) && USE_ASM_nn_mat_vec_mul_s8)
 #define HAS_ASM (1)
#else
 #define HAS_ASM (0)
#endif

// static unsigned seed = 345623;

#define DEBUG_ON    (0 || TEST_DEBUG_ON)
#define N           (32)
#define M           (16)
void test_nn_mat_vec_mul_s8_case1()
{
    int8_t WORD_ALIGNED c_y[M];

    int8_t WORD_ALIGNED x[N] = {0};
    int8_t WORD_ALIGNED W[M*N] = {0};
    int16_t shr[M] = {0};

    unsigned N_bands = M / VPU_INT8_ACC_PERIOD;
    unsigned N_chunks = N / VPU_INT8_EPV;

    for(int i = 0; i < N; i++) x[i] = 100;

    int8_t exp_res8[M] = {0};

    memset(c_y, 0xCC, sizeof(c_y));

    nn_mat_vec_mul_s8_c(W, x, N_bands, N_chunks, shr, c_y);
#if HAS_ASM
    int8_t WORD_ALIGNED asm_y[M];
    memset(asm_y, 0xCC, sizeof(asm_y));
    nn_mat_vec_mul_s8_asm(W, x, N_bands, N_chunks, shr, asm_y);
#endif

    for(int i = 0; i < M; i++){
        char str_buff[100];
        sprintf(str_buff, "(output index %u)", i);
 
        TEST_ASSERT_EQUAL_INT32_MESSAGE(exp_res8[i], c_y[i], str_buff);
#if HAS_ASM
        TEST_ASSERT_EQUAL_INT32_MESSAGE(exp_res8[i], asm_y[i], str_buff);
#endif
    }
}
#undef M
#undef N
#undef DEBUG_ON


#define DEBUG_ON    (0 || TEST_DEBUG_ON)
#define N           (96)
#define M           (32)
void test_nn_mat_vec_mul_s8_case2()
{
    int8_t WORD_ALIGNED c_y[M];

    int8_t WORD_ALIGNED x[N] = {108,126,69,-89,-45,101,97,66,-34,76,14,-41,-110,-73,100,-9,73,-28,-12,-108,-109,-29,95,3,86,84,-3,51,-70,106,-1,-11,53,54,51,43,111,62,96,-79,47,-110,-51,112,39,-116,15,-26,20,92,3,-33,0,58,45,-42,65,-56,-6,-18,-89,-44,-108,-60,78,59,-17,-61,-92,-6,83,47,101,11,113,55,92,27,-60,46,-75,-108,-75,-97,-126,-80,-39,61,16,92,95,74,-31,46,105,84};
    int8_t WORD_ALIGNED W[M*N] = {-18,-49,94,65,88,64,-56,-112,-56,-63,66,-49,-76,-86,-12,74,6,2,-63,-96,64,32,36,-65,33,-115,76,58,68,-46,-61,106,-52,-87,-108,53,124,-24,-25,64,50,99,-29,49,-58,90,-70,-9,54,-13,71,33,-83,88,-125,-56,-115,13,22,-35,-67,72,124,16,-5,-15,-10,-105,-99,106,-90,110,-78,82,117,102,13,19,-88,111,71,-17,108,-100,16,-51,98,69,110,-125,-56,111,-114,48,19,115,27,-107,63,15,-48,105,-36,-86,109,-22,-27,-9,-44,53,-45,-76,72,-4,114,96,61,102,3,17,60,-42,20,-53,107,-18,-44,104,-43,104,7,-119,-35,80,11,56,-105,-27,-12,-18,85,17,-78,107,-85,56,67,-46,78,-22,-22,45,-30,-1,31,-18,14,-111,-104,-67,80,-94,53,17,-89,71,-65,107,-28,-67,-39,59,9,-18,-121,117,20,-95,114,86,-2,-27,26,80,-69,25,-14,39,-97,43,-51,-35,123,89,19,111,-16,-28,-12,-95,-81,-45,84,13,80,-29,-88,96,118,-127,12,109,84,-16,-29,-47,68,-44,11,45,-43,41,37,75,95,85,67,75,85,45,-115,-30,100,-87,98,-18,-14,69,-86,86,7,-55,100,68,-112,-61,-86,41,69,-120,-52,70,-55,17,-1,4,97,83,58,-42,110,16,-25,70,87,6,44,41,30,-19,64,25,-74,-107,29,115,63,51,117,-119,-32,-8,105,21,-107,8,-64,0,-31,49,-2,115,-87,26,114,-63,89,-63,-16,19,22,-10,-73,115,29,-92,-107,103,-44,-91,39,120,-80,-43,-122,47,8,-117,-90,-8,-38,27,13,46,106,111,-45,-81,-7,7,85,-92,-49,-21,-68,-122,24,23,-97,-94,56,82,-56,100,78,51,28,-119,16,20,-86,78,65,-64,36,3,8,-108,-12,-78,31,-64,-1,-9,5,-54,-115,-15,-81,62,12,-20,104,84,15,48,-57,-22,-127,-76,-38,-75,-109,69,58,82,-59,125,-49,-73,-117,86,-46,104,-32,32,28,45,94,-42,-122,83,49,108,-114,-73,112,-20,24,-56,59,-24,89,-39,31,-71,82,65,56,89,-24,110,89,-13,-119,-39,66,-121,-60,-123,29,-39,-111,124,-56,61,84,74,49,18,57,48,-3,61,-115,-89,-100,-125,-55,2,16,-36,37,66,112,38,-122,29,54,122,116,60,13,-61,37,-20,-88,56,-87,-67,-35,22,-120,-73,-114,-13,108,-48,-26,103,-80,95,59,81,-73,45,68,-100,71,64,88,-11,-60,-38,113,5,88,10,-16,83,91,39,47,-112,-123,-123,100,43,-33,76,69,95,-15,31,-5,1,-55,-93,-65,69,-126,-10,11,-58,87,124,105,-49,-114,102,-35,95,94,-117,-97,53,-85,-80,-93,52,80,-15,108,-15,-64,36,0,105,109,-111,-55,29,-57,-109,-110,-38,-61,48,-62,-122,21,-21,46,-48,-111,-35,40,125,59,58,84,94,86,27,-14,71,110,64,59,44,99,-46,16,-41,78,-115,40,46,-58,91,102,-9,-28,55,87,100,33,96,93,17,73,-93,-81,-72,103,99,-108,113,-69,-112,103,-52,105,-63,-54,24,-56,19,8,-17,74,21,-109,10,-11,-66,-25,-94,-117,-52,-15,116,-30,-93,-22,44,-85,125,18,33,19,-73,-53,-106,67,77,-70,99,-126,-77,123,-111,-107,104,35,-47,-4,59,-27,11,97,-118,78,-101,-44,-15,27,31,43,-123,-6,70,-36,112,-65,3,105,-93,116,81,77,-86,-66,87,104,47,48,-62,-83,-43,-8,-38,-86,11,-63,-47,64,91,-65,82,113,-106,-19,52,107,15,85,-63,-77,-15,122,81,-66,-88,115,65,-91,-16,-112,-2,-44,-71,-115,-84,61,48,-9,-14,-58,-54,-79,-53,70,-54,88,11,64,-83,-13,-39,55,-72,29,118,-56,26,-105,-82,57,-50,-11,69,7,-53,25,125,-1,-83,-99,9,-92,-36,-33,109,-46,-111,85,-65,24,59,92,71,-23,-65,-15,-90,112,-75,112,57,-105,-125,-81,53,115,67,-117,-96,-114,-101,-119,-51,-64,101,-103,-34,34,109,-22,97,83,-4,32,-44,4,-44,-117,46,81,-89,-81,30,-91,19,52,-19,-20,-112,-58,38,61,40,-111,30,94,46,-18,62,-81,93,11,-63,52,-70,73,-49,-80,-32,-49,-79,-57,-70,-82,25,80,83,-118,-86,46,19,2,-101,12,71,59,24,66,-22,77,8,87,77,111,68,28,-88,-62,-23,-10,-65,-105,-31,86,0,46,33,102,49,0,-118,81,69,-79,109,-71,-95,121,-44,-8,79,72,52,2,-26,97,-85,-121,11,124,5,-34,2,37,-126,95,-120,-51,-39,-99,-27,56,-46,125,117,-127,66,27,-8,97,99,-67,-60,15,74,-78,51,84,-74,-61,-7,77,63,71,49,-88,78,-77,-74,-116,73,116,-99,100,-89,-40,37,-106,-33,-106,-92,46,96,-51,116,20,47,56,-76,17,70,-45,37,-84,-70,119,98,58,55,-124,-118,-78,-84,-18,99,-54,49,-46,-53,-85,-33,-35,28,68,58,-115,-37,45,124,33,-53,85,-107,-21,-61,103,-38,27,18,-22,67,-76,-57,116,-33,19,125,12,102,-98,-67,-45,118,76,6,-96,-30,-45,73,-84,-67,59,-52,55,-2,-77,-94,46,-55,-21,122,37,-36,-42,-127,-115,-68,-95,60,-102,-16,103,-97,119,100,14,4,35,61,-69,44,30,67,8,-44,92,-103,-117,93,-4,80,-117,31,-90,-23,-88,83,-78,-125,-89,-111,124,-117,68,-72,11,5,-106,96,-4,-12,18,92,80,-37,-84,87,70,-96,-66,55,85,20,-6,109,-123,-38,-14,83,94,77,-107,-127,-92,-37,113,0,-64,90,-49,-46,-17,-119,-31,115,-88,111,-52,41,115,90,-89,-98,10,-25,93,-84,-11,22,-4,7,61,-84,116,-60,-106,10,-1,-26,121,-1,97,36,116,85,21,108,5,-29,108,-21,-45,-1,-35,110,-46,-28,-121,76,-48,49,-1,40,93,-87,100,-116,118,-63,-80,83,-13,-119,58,77,35,-12,38,68,-92,-11,65,51,-29,16,83,35,-50,-12,107,-124,-109,-33,93,88,125,77,-93,37,-61,-61,77,21,-88,-102,-53,28,123,103,36,110,-84,70,28,78,-9,-44,-91,123,107,9,-108,-112,-100,122,-108,93,-72,3,-99,2,-125,-47,87,7,-81,114,-61,84,65,-79,88,-45,-1,25,76,66,97,-36,57,97,-55,98,-52,-59,-1,-112,94,114,-57,-109,-21,102,-29,76,49,-110,-124,-37,73,-24,92,-76,1,38,-55,-4,-88,-23,88,-8,94,123,-52,126,113,32,-47,-78,19,-1,-38,31,-104,-17,-121,52,105,111,-124,125,-3,123,-28,85,-64,54,102,-78,15,126,69,96,109,-106,17,118,-7,116,-30,-47,-107,-22,-68,74,50,125,22,-30,-52,-100,124,21,-56,-57,-77,-68,9,-76,19,81,106,-122,45,81,-25,-116,93,102,119,63,-55,14,6,22,32,-64,69,-22,97,-124,-9,44,-48,21,10,-104,-104,114,2,47,58,23,-89,91,121,-97,89,34,67,107,22,23,11,-72,-123,119,-117,117,126,119,-53,-117,-69,-10,-24,9,-58,42,-116,-124,120,-99,-96,-115,-89,-119,77,-92,-33,6,-85,123,83,-100,116,111,-96,-112,121,76,-110,115,61,-76,101,-96,68,84,-62,-90,-47,98,-84,-84,125,69,65,44,52,-86,29,48,124,6,-36,-105,-88,89,-41,43,-49,33,-96,-63,-79,-37,4,51,78,0,105,87,-97,-114,-17,-124,30,-13,84,95,-27,78,-41,-26,112,126,6,-27,90,63,18,-102,-95,19,15,-126,-62,57,49,86,30,14,-75,-105,106,10,-108,-67,-47,10,63,-123,22,32,-122,23,-122,-65,-12,41,55,-43,99,104,36,100,-71,-77,-70,86,-19,80,3,81,-92,70,-64,-106,6,-7,-87,-119,63,-98,-58,124,-94,16,6,23,5,-42,-47,-95,-108,26,-77,51,95,-42,-27,-102,48,101,19,-7,61,-73,47,50,-100,76,41,91,81,94,-23,45,-30,66,108,48,16,-4,-123,94,52,-64,-61,-57,-117,18,-14,-2,-68,-70,1,-113,117,-82,56,-108,120,51,-20,-25,-89,-95,34,-52,-94,-42,-106,25,-101,97,-34,101,113,-29,-76,17,-44,-34,108,-123,-88,-83,38,51,-51,-77,0,103,-6,50,-96,-24,-83,50,17,21,32,-123,91,-110,92,88,-120,-18,-63,-28,77,-57,77,47,-72,-64,75,-81,-84,-18,-66,-78,56,23,54,-126,13,-27,21,-123,26,98,-84,118,0,-64,-39,59,88,114,-112,-17,78,-89,-74,124,-48,60,-7,-84,-56,-11,-92,-87,3,-79,-58,-62,91,-117,19,-39,-22,15,-37,-57,104,31,123,51,1,9,76,111,-99,-92,14,76,-119,-85,-16,96,-85,84,109,18,-57,107,54,83,21,27,-53,109,-80,-60,100,3,23,46,119,119,62,-58,120,-56,28,-30,-69,-50,97,24,56,-80,-65,-81,57,-110,-103,-64,-23,59,-40,-50,-55,-121,74,120,-106,-97,14,61,94,-58,-78,-99,-78,64,29,-2,-12,-68,-79,92,2,-124,15,61,-8,-29,39,98,-72,66,-101,95,118,-62,-7,-123,-81,50,-53,36,-113,-120,56,113,-46,-81,91,54,-73,-1,-29,52,-28,4,66,67,61,-120,-106,-17,18,123,100,-31,-31,67,-48,-92,-88,-9,-45,-23,67,-57,-21,36,81,-16,-78,53,-106,-92,53,-68,-47,21,-73,13,-63,-37,-17,54,-105,-4,29,-45,59,-8,113,-32,-80,59,12,9,-86,60,1,-111,-31,99,-121,8,112,63,-16,-85,14,-97,121,36,116,-16,-111,77,-46,49,-50,-3,-52,-92,17,15,-84,120,75,-115,69,-92,12,117,68,-63,123,-16,32,104,-117,123,-6,49,82,54,-62,62,50,10,-6,22,19,43,-107,52,-14,-105,102,76,-71,-74,7,95,25,22,-106,-30,-113,4,79,-119,-9,37,-61,27,90,-83,-43,108,35,113,85,-26,7,68,6,-83,-45,-19,115,-20,-89,56,83,-4,-1,81,75,69,117,112,-101,-2,-18,16,-73,-70,74,-59,-80,29,-117,-91,124,28,-117,104,126,26,-92,106,39,-117,26,-112,-9,-28,-104,-10,-111,7,-90,-97,78,30,-119,-72,-91,-127,-19,-63,-41,-28,-85,96,103,-12,-90,35,20,-57,-49,-89,-68,-16,112,-84,-113,31,-10,-9,87,47,-107,102,27,-12,-61,94,-28,-112,20,-49,-61,25,122,-78,120,-53,-52,93,-118,29,125,54,-32,-94,49,43,-107,-35,58,-10,108,-20,-116,114,78,15,88,-30,-3,95,-78,-83,-36,74,-33,55,-84,56,55,-118,-16,17,-124,-72,82,-21,-79,-103,-35,122,-69,-113,90,-119,77,116,-11,-84,111,-42,27,121,-120,-84,-92,-33,-55,61,101,48,50,83,63,90,-126,-42,-88,-101,45,-113,-50,-96,117,-103,-51,24,-100,-55,84,-74,29,92,-123,106,-1,116,75,-121,-5,82,-43,-78,-17,118,-92,-24,88,27,105,54,-61,-127,13,18,-5,-25,-62,-12,56,-62,89,93,-63,-14,-84,17,-85,58,94,-123,-80,109,68,-60,5,-41,-63,22,-73,63,55,-121,-124,-79,35,114,-96,104,69,95,-87,48,-81,-125,-72,59,-88,-12,-45,-121,73,-16,-127,-43,-72,41,-13,-68,-35,71,106,-122,-79,-65,44,-120,-39,51,95,-118,36,123,-16,-11,-50,97,114,56,32,-115,-79,-113,63,-2,-107,-47,61,-42,-50,10,59,-81,-86,-72,122,-9,125,23,57,-79,121,3,102,-29,31,22,-58,90,13,90,86,69,73,15,-80,70,-111,-74,-56,-68,-66,-90,72,103,36,-112,11,-67,-93,-112,-108,-48,74,14,58,-117,73,56,-117,111,-94,-79,12,60,14,2,-118,-114,-36,112,-32,-72,-70,-21,-15,15,122,126,16,-67,117,46,-107,70,-96,-52,34,-107,-55,-40,62,-92,113,-52,-12,-20,87,-94,-113,98,-59,5,-45,-107,37,-19,32,27,62,1,-50,101,36,96,123,111,-24,-117,81,108,51,116,43,75,-38,-104,-50,-28,124,-97,2,10,-15,6,9,122,22,-91,-38,-124,48,120,-88,109,-8,-59,9,-113,23,17,29,103,-117,70,-68,32,22,-1,-57,-123,-39,-44,-90,82,75,66,-77,1,109,96,-35,-23,-101,35,-20,-101,106,124,-52,-106,86,-47,12,-54,-79,106,36,12,11,-117,-40,-109,-25,-23,59,125,-56,48,8,38,37,90,-15,14,-82,20,-98,-16,-117,68,-107,-120,-21,-49,-110,-74,-91,-112,99,-123,15,-7,-76,-66,25,47,101,-17,-94,-31,-50,-63,-111,6,-63,95,-12,33,-90,-46,-29,65,-47,2,-111,97,-61,93,44,44,-67,80,-40,-1,-16,-104,-30,48,-103,-40,-7,41,20,68,-5,-2,-28,-54,23,-86,93,-94,-55,-38,19,-11,59,-82,53,-28,-100,-53,114,116,22,47,-23,57,21,72,-100,-32,21,-58,-42,39,-117,-111,9,-65,120,-37,68,-118,11,-14,-125,8,91,-80,117,-43,6,115,-114,-66,67,-3,-2,-22,92,101,57,-58,2,-3,68,91,64,49,-123,-49,87,-52,-78,42,34,84,56,-35,114,-65,-121,-123,108,27,-49,-58,-9,-2,73,53,93,-24,-116,111,126,19,-11,-9,-90,41,78,-123,56,-14,-47,-29,-124,-43,66,-126,-25,19,9,-69,114,39,-77,-60,-68,-106,-47,16,-10,94,3,71,31,-98,98,-107,68,71,108,-82,-35,15,-91,-96,102,2,-12,85,93,-86,5,-72,-36,-113,-47,-127,110,126,2,70,95,-100,78,6,-29,111,88,-2,9,-19,117,45,118,50,105,-118,40,-126,52,-19,-73,38,-104,-98,56,-28,-48,2,80,16,-8,-108,-68,-92,0,94,-83,-77,71,107,81,92,-82,-105,68,93,-127,-52,-24,80,109,-57,30,44,42,8,-61,-31,-102,-90,-102,89,65,95,54,53,38,-89,47,-58,65,45,31,-61,77,123,105,-15,-105,6,-96,0,-23,-103,-41,-86,90,-69,83,-22,8,118,124,-111,-19,5,-82,-126,84,83,-91,47,-61,43,92,82,41,112,26,-90,-63,94,-3,-15,-53,-47,-17,-94,126,-34,-26,-5,34,-84,118,17,13,44,-77,116,-95,17,49,65,-10,-38,27,121,-28,110,64,126,97,-46,-109,62,46,97,76,-101,26,-18,-95,-109,79,-115,-42,89,-48,-120,-9,35,-52,-94,-25,-20,85,-50,66,62,49,99,-101,123,11,-82,-125,99,-64,70,114,83,62,123,52,-49,75,96,-18,-113,-91,102,-104,81,112,96,-52,-3,120,-11,-112,25,68,85,-92,14,47,23,28,89,-31,-45,-46,-7,0,-93,-123,-123,5,21,106,32,-5,-56,79,-106,109,102,95,-82,-47,-125,16,-9,32,4,63,-108,120,7,83,-30,100,100,-58,114,105,-94,122,-39,86,37,102,10,-52,-28,-88,85,-88,116,-101,-63,-51,126,13,104,-74,-14,-124,-11,3,-65,-8,0,-32,-104,61,87,-119,-98,-101,102,-47,-98,-79,24,92,107,-37,120,-21,-96,14,50,-91,66,99,-94,122,-70,23,123,27,39,-122,45,-22,-92,75,-89,-107,-120,2,77,51,83,62,47,-40,-34,-42,122,-94,117,116,-17,-100,-20,103,108,-82,119,101,36,-43,90,118,-48,65,-20,-98,12,-3,-34,70,63,-123,104,-108,-66,-88,80,-15,-31,-6,-121,53,-73,101,96,113,-41,-50,117,76,-126,-50,-77,-50,4,-25,77,-78,36,37,93,-58,-34,-3,95,22,28,124,61,-82,-38,-80,-57,113,83,-65,75,-6,-84,-30,-2,47,8,13,64,64,-103,86,123,119,47,-21,105,84,2,32,-24,53,14,96,35,117,19,105,21,-117,-120,-109,-126,58,-87,10,-51,-72,25};
    int16_t shr[M];

    unsigned N_bands = M / VPU_INT8_ACC_PERIOD;
    unsigned N_chunks = N / VPU_INT8_EPV;

    for(int i = 0; i < M; i++) shr[i] = 10;

    int8_t exp_res8[M] = {-53,-58,11,35,-107,-7,-33,27,-18,-44,55,-46,-86,113,-82,-118,
                            25,-22,-20,53,22,-9,-53,-2,-62,84,-4,-30,7,-16,47,-18};

    memset(c_y, 0xCC, sizeof(c_y));

    nn_mat_vec_mul_s8_c(W, x, N_bands, N_chunks, shr, c_y);
#if HAS_ASM
    int8_t WORD_ALIGNED asm_y[M];
    memset(asm_y, 0xCC, sizeof(asm_y));
    nn_mat_vec_mul_s8_asm(W, x, N_bands, N_chunks, shr, asm_y);
#endif

    for(int i = 0; i < M; i++){
        char str_buff[100];
        sprintf(str_buff, "(output index %u)", i);
        // printf("%d\t%ld\t%ld\t\t%d\t%d\n", i, exp_res[i], c_acc[i], exp_res8[i], c_y[i] );
 
        TEST_ASSERT_EQUAL_INT32_MESSAGE(exp_res8[i], c_y[i], str_buff);
#if HAS_ASM
        TEST_ASSERT_EQUAL_INT32_MESSAGE(exp_res8[i], asm_y[i], str_buff);
#endif
    }
}
#undef M
#undef N
#undef DEBUG_ON


void test_nn_mat_vec_mul_s8()
{
    test_nn_mat_vec_mul_s8_case1();
    test_nn_mat_vec_mul_s8_case2();
}

